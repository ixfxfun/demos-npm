# ml/pose

Acronyms
* ML: Machine Learning
* MP: MediaPipe

* [MediaPipe overview](https://ai.google.dev/edge/mediapipe/solutions/vision/pose_landmarker)

# Architecture

A _sender_ sketch reads data from a source (webcam, video, or recorded points) and emits it via [Remote](https://github.com/clinth/remote)

This sketch shouldn't need to be modified, but it is how some Tensorflow settings can be tweaked. In `pose/head`, we show how to embed the source in the page via an `IFRAME`. The downside of this is that with every little change in your code, the sender has to also reload - and this can be cumbersome when we are accessing media.

Instead, the idea is to open the sender sketch in a separate window and leave it running. Note that if you minimise or cover it over with another window too much, the browser may suspend Javascript execution (as a battery-saving mechanism).

Tip: There are tools for Windows & Mac to make any window stay on top of all other windows.

Your sketch receives pose data from the sender. If you're running the same browser, this will be very fast and data never leaves your machine. You can activate Remote's network capabilities to run the sender/receiver on separate machines. Or even multiples of them!

In your own sketch, you can import stuff relating to MoveNet via:

```js
import * as MoveNet from "../Poses.js";
```

...assuming your sketch is located at `demos/ml/pose/YOUR-SKETCH` and thus accessible via _http://localhost:5555/ml/pose/YOUR-SKETCH_

If your sketch is in the top-level of the `demos` directory (ie. `demos/YOUR-SKETCH` and via _http://localhost:5555/YOUR-SKETCH_), this import ought to work:

```js
import * as MoveNet from "./ml/pose/Poses.js";
```

## Pose ids

Pose ids are generated when TF starts tracking a body. If it loses tracking, the same human body might get assigned a new id. Ids are generated by the sender sketch. Since there could be multiple senders, we can't use the pose id to properly separate poses. Thus, we use a 'guid' (globally-unique id). This consists of the sender's id and the pose id. If the sender's id is '407-33', and the pose id is 1, the guid of that pose will be '407-33-1'.

# PoseTracker

`PoseTracker` keeps track of a keypoints for a single pose. This is useful for tracking the movement of a pose or its keypoints over time. It does this by making a [PointTracker](https://api.ixfx.fun/classes/Trackers.PointTracker) for each keypoint of a pose.

Fields
* `hue`: randomly-assigned hue for this pose (0..360)
* `guid`: globally-unique id for pose (consisting of sender id and pose id)
* `fromId`: sender id
* `poseId`: original pose id (warning: potentially conflicting with other pose ids if we have several senders)

Example
```js
const hsl = `hsl${pose.hue},50%,50%}`;
```

## Accessing keypoints

You can get the raw keypoint data from the pose:
```js
// Get a single point
const nosePoint = pose.keypointValue(`nose`); // { x, y, score, name }

// Get all points
for (const kp of poses.getRawValues()) {
  // { x, y, score, name }
}
```

But the real power comes from getting the [PointTracker](https://api.ixfx.fun/classes/Trackers.PointTracker) for a keypoint, since it keeps track of not just the last data, but a whole trail of historical data for a given keypoint.

```js
const noseTracker = pose.keypoint(`nose`); // PointTracker
```

Once we have the PointTracker, there are a _lot_ of things to access:
```js
noseTracker.angleFromStart();
noseTracker.distanceFromStart();
noseTracker.difference(); // x&y difference from last and start
noseTracker.lineStartEnd; // { x, y } - Line from start to end
noseTracker.x;  // Last x coordinate
noseTracker.y;  // Last y coordinate

// Movement vectors
noseTracker.vectorCartesian;
noseTracker.vectorPolar;

noseTracker.elapsed;
noseTracker.initial; // { x, y }
noseTracker.last;    // { x, y, timestamp }
noseTracker.length; // Number of points - not distance!
// Last computed results
noseTracker.lastResult // {fromInitial,fromLast,values}
```


# PosesTracker

`PoseTracker` keeps track of a single pose (ie body), `PosesTracker` keeps track of several bodies!

## Setup

To create:
```js
const poses = new MoveNet.PosesTracker();
```

TIP: In this readme, if we use the variable `poses`, it refers to an instance of `PosesTracker`.

You can provide some options to override the default behaviour. The options are:
```js
// Remove a pose if it hasn't been seen for this long
maxAgeMs: 10_000,
// Reset keypoint tracker after this many samples/
// 0 disables
resetAfterSamples: 0,
// How many samples to store if 'storeIntermediate' is enabled
sampleLimit: 100,
// Whether to store data for each pose keypoint
storeIntermediate:false
```

For example:

```js
const poses = new MoveNet.PosesTracker({
  // Remove a pose if we haven't seen it for 30seconds
  maxAge: 30_000
})
```

## Adding data

Whenever we receive pose data, you need to pass it to the tracker. To use it, call `seen`, passing the id of the sender, and the pose.

Eg. to add all received poses:

```js
remote.onData = (packet) {
  const { _from, data } = packet;
  const poseData =/** @type Types.Pose[] */(data);
  for (const pose of poseData) {
    settings.poses.seen(_from, pose);
  }
};
```

## Listening for changes

The poses tracker helpfully emits events to let you know if a pose appears for the first time, or when it disappears (eg because the body has moved out of camera frame, or we lose tracking)

```js
poses.events.addEventListener(`expired`, event => { 
  const poseTracker = event.detail;
  console.log(`Pose expired: ${poseTracker.guid}`);
});

poses.events.addEventListener(`added`, event => {
  const poseTracker = event.detail;
  console.log(`Pose added: ${poseTracker.guid}`);
});
```

## Enumerating data

* trackers, regardless of sender: `get` 
* trackers, sorted by age: `getByAge` (position 0 is most recently updated pose)
* trackers, sorted by score: `getByScore` (position 0 is highest-ranked score)
* trackers, sorted by horizontal position `getByHorizontal` (position 0 is the left-most pose)
* trackers from a particular sender: `getFromSender(senderId)`
* sender ids: `getSenderIds`
* raw pose data regardless of sender: `getRawPoses` (`getRawPosesByAge` sorts by last updated)

```js
// Get all PoseTrackers (ie. all visible bodies)
for (const tracker of poses.get()) {
  // Since we have the tracker, we can do low-level work with keypoints
}

// Get the raw pose data (ie all visible bodies), sorted by age
for (const pose of poses.getRawPosesByAge()) {
  pose.keypoints; // array of { x, y, z?, score, name }
}
```

## Accessing a particular pose

Since we may have multiple senders which may have overlapping pose ids, to access a pose, we need the sender's id as well as the pose id.

Use `getByGuid(guid)` to get the tracker, or `getRawPoseByGuid` to get the raw pose data.
```js
// Get the corresponding tracker
const trackerForPose = poses.getByGuid(`902-42-10`);

// Get the last raw pose data
const poseData = poses.getRawPoseByGuid(`902-42-10`);
```

If we don't have the sender id for some reason, or if you can be sure there's only one sender, you can get a pose by it's id with `getByPoseId`. This returns a `PoseTracker` instance.

```js
// Get the corresponding tracker
const trackerForPose = poses.getByPoseId(`10`);

// Get the last raw pose data
const poseData = poses.getRawPoseByPoseId(`10`);
```


# Recording

Point data is recorded to the browser's local storage. Image data is are not stored.

# Utility

A few utility functions are available when importing:
```js
import * as MoveNet from "../Poses.js";
```


Sort array of poses horizontally:
```js
const sorted = MoveNet.horizontalSort(poses);
```

Get centroid of pose (including all keypoints):
```js
const centroid = MoveNet.centroid(pose); // {x,y}
```

Return a line between two named points. If either of the points is not found, _undefined_ is returned. This is useful for using with ixfx's Line module.
```js
const line = MoveNet.lineBetween(pose, `left_shoulder`, `right_shoulder`);
// { a: { x, y }, b: { x, y } }
```

Gets the center based on the torso (between shoulders and hips). If
any of the needed points is not found, _undefined_ is returned.
```js
const c = MoveNet.roughCenter(pose); // { x, y }
```

# Troubleshooting

## https

Your code will not be able to access media devices like a camera if it's being loaded from an insecure connection.

If you're running a local server, make sure you're using http://127.0.0.1 as the address. If you're running from an online hosting service, make sure you're accessing via `https://`.
